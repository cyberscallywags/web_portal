{% extends "base.html" %}
{% block title %}Contact - Cyber Scallywags{% endblock %}
{% block content %}
<style>
    @keyframes moveGrid {
        0% { transform: translate(0, 0); }
        100% { transform: translate(50px, 50px); }
    }

    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Hero Section */
    .contact-hero {
        background: linear-gradient(135deg, #00B1B3 0%, #0e6abd 50%, #4006a7 100%);
        padding: 100px 0;
        position: relative;
        overflow: hidden;
        text-align: center;
    }

    .contact-hero::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: 
            linear-gradient(rgba(193, 228, 21, 0.03) 2px, transparent 2px),
            linear-gradient(90deg, rgba(193, 228, 21, 0.03) 2px, transparent 2px);
        background-size: 50px 50px;
        animation: moveGrid 3s linear infinite;
        pointer-events: none;
    }

    .contact-hero .container {
        position: relative;
        z-index: 1;
        max-width: 900px;
        margin: 0 auto;
        padding: 0 20px;
    }

    .contact-hero h1 {
        font-size: 3.5rem;
        font-weight: 700;
        color: #fff;
        margin: 0 0 20px 0;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        animation: slideInUp 0.8s ease-out;
    }

    .contact-hero p {
        font-size: 1.3rem;
        color: #C1E415;
        margin: 0;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        animation: slideInUp 0.8s ease-out 0.2s backwards;
    }

    /* Form Section */
    .contact-form-section {
        max-width: 800px;
        margin: -50px auto 80px;
        padding: 0 20px;
        position: relative;
        z-index: 10;
    }

    .form-container {
        background: #fff;
        border-radius: 20px;
        padding: 50px 40px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        animation: slideInUp 0.6s ease-out;
    }

    .form-container h2 {
        font-size: 2rem;
        color: #4006a7;
        margin-bottom: 30px;
        text-align: center;
    }

    .form-label {
        color: #333;
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 0.95rem;
    }

    .form-control, .form-select {
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        padding: 12px 16px;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: #C1E415;
        box-shadow: 0 0 0 3px rgba(193, 228, 21, 0.1);
        outline: none;
    }

    .form-check-input:checked {
        background-color: #4006a7;
        border-color: #4006a7;
    }

    .form-check-label {
        color: #555;
        font-size: 0.95rem;
    }

    .btn-primary {
        background: linear-gradient(135deg, #4006a7, #0e6abd);
        border: none;
        border-radius: 25px;
        padding: 14px 40px;
        font-size: 1.1rem;
        font-weight: 600;
        color: #fff;
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #CC0084, #4006a7);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(64, 6, 167, 0.3);
    }

    .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    #formStatus {
        display: inline-block;
        font-weight: 600;
        font-size: 1rem;
    }

    .invalid-feedback {
        color: #dc3545;
        font-size: 0.875rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .contact-hero h1 {
            font-size: 2.5rem;
        }

        .contact-hero p {
            font-size: 1.1rem;
        }

        .form-container {
            padding: 35px 25px;
        }
    }
</style>

<section class="contact-hero">
    <div class="container">
        <h1>Contact Cyber Scallywags üê∫</h1>
        <p>We're here to help. Get in touch with our team today!</p>
    </div>
</section>

<section class="contact-form-section">
    <div class="form-container">
        <h2>Get in Touch</h2>
        <form id="joinForm" data-api-url="/api/contact" class="row g-3" novalidate>
            
            <!-- Form Type Selector -->
            <div class="col-12">
                <label for="formType" class="form-label">What would you like to do?</label>
                <select class="form-select" id="formType" name="formType" required>
                    <option value="mailing-list">üì∞ Join mailing list</option>
                    <option value="apply-to-join">üìù Apply to join</option>
                    <option value="general-enquiry">‚ÑπÔ∏è General enquiry</option>
                </select>
                <div class="invalid-feedback">Please select an option.</div>
            </div>

            <!-- Name field -->
            <div class="col-md-6">
                <label for="name" class="form-label">Full name</label>
                <input type="text" class="form-control" id="name" name="name" required maxlength="120" placeholder="Your name">
                <div class="invalid-feedback">Please provide your name.</div>
            </div>

            <!-- Email field -->
            <div class="col-md-6">
                <label for="email" class="form-label">Email address</label>
                <input type="email" class="form-control" id="email" name="email" required maxlength="254" placeholder="you@example.com">
                <div class="invalid-feedback">Please provide a valid email.</div>
            </div>

            <!-- Role field - only for apply-to-join -->
            <div class="col-12 field-role" style="display: none;">
                <label for="role" class="form-label">Interest / Role</label>
                <input type="text" class="form-control" id="role" name="role" placeholder="e.g. volunteer, mentor, learner">
            </div>

            <!-- Message field -->
            <div class="col-12 field-message" style="display: none;">
                <label for="message" class="form-label"><span class="message-label">Optional message</span></label>
                <textarea id="message" name="message" class="form-control" rows="4" maxlength="1000" placeholder="Tell us a bit about yourself (optional)"></textarea>
            </div>

            <!-- Consent checkbox -->
            <div class="col-12 form-check">
                <input class="form-check-input" type="checkbox" value="yes" id="consent" required>
                <label class="form-check-label" for="consent">
                    I consent to my details being stored and used to contact me.
                </label>
                <div class="invalid-feedback">Consent is required.</div>
            </div>

            <div class="col-12 text-center mt-4">
                <button id="submitBtn" class="btn btn-primary">Send Request</button>
                <div class="mt-3">
                    <span id="formStatus" aria-live="polite"></span>
                </div>
            </div>
        </form>
    </div>
</section>

<script>
(function () {
  const form = document.getElementById('joinForm');
  const statusEl = document.getElementById('formStatus');
  const formTypeSelect = document.getElementById('formType');
  const roleField = document.querySelector('.field-role');
  const messageField = document.querySelector('.field-message');
  const messageLabel = document.querySelector('.message-label');
  const roleInput = document.getElementById('role');
  const messageInput = document.getElementById('message');
  const apiUrl = form.dataset.apiUrl || '/api/contact';

  formTypeSelect.addEventListener('change', function() {
    const formType = this.value;
    
    roleField.style.display = 'none';
    messageField.style.display = 'none';
    roleInput.required = false;
    messageInput.required = false;
    
    switch(formType) {
      case 'mailing-list':
        break;
        
      case 'apply-to-join':
        roleField.style.display = 'block';
        messageField.style.display = 'block';
        roleInput.required = true;
        messageLabel.textContent = 'Tell us about yourself';
        messageInput.placeholder = 'Tell us about your experience and/or why you want to join';
        messageInput.required = true;
        break;
        
      case 'general-enquiry':
        messageField.style.display = 'block';
        messageLabel.textContent = 'Your message';
        messageInput.placeholder = 'Please tell us how we can help you';
        messageInput.required = true;
        break;
    }
  });

  function setStatus(msg, ok = true) {
    statusEl.textContent = msg;
    statusEl.style.color = ok ? '#C1E415' : '#dc3545';
  }

  form.addEventListener('submit', async function (e) {
    e.preventDefault();
    e.stopPropagation();

    if (!form.checkValidity()) {
      form.classList.add('was-validated');
      setStatus('Please correct the highlighted fields.', false);
      return;
    }

    const payload = {
      formType: formTypeSelect.value,
      name: form.name.value.trim(),
      email: form.email.value.trim().toLowerCase(),
      role: form.role.value.trim(),
      message: form.message.value.trim(),
      consent: !!document.getElementById('consent').checked,
      submitted_at: new Date().toISOString()
    };

    try {
      const existing = JSON.parse(localStorage.getItem('contact_pending') || '[]');
      existing.push(payload);
      localStorage.setItem('contact_pending', JSON.stringify(existing));
    } catch (err) {}

    setStatus('Sending...', true);
    document.getElementById('submitBtn').disabled = true;

    try {
      const res = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify(payload),
        credentials: 'same-origin'
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || 'Server returned an error');
      }

      setStatus('Request sent. Thank you ‚Äî we will be in touch soon.', true);
      form.reset();
      form.classList.remove('was-validated');
      
      roleField.style.display = 'none';
      messageField.style.display = 'none';
      roleInput.required = false;
      messageInput.required = false;

      localStorage.removeItem('contact_pending');
    } catch (err) {
      console.error('Contact form error:', err);
      setStatus('Failed to send ‚Äî your request is saved locally and will be retried later.', false);
    } finally {
      document.getElementById('submitBtn').disabled = false;
    }
  });

  window.addEventListener('online', async function () {
    const pending = JSON.parse(localStorage.getItem('contact_pending') || '[]');
    if (!pending.length) return;
    setStatus('Retrying pending requests...', true);

    for (const p of pending.slice()) {
      try {
        const res = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify(p),
          credentials: 'same-origin'
        });
        if (!res.ok) throw new Error('Server error');
      } catch (err) {
        console.warn('Retry failed', err);
        setStatus('Retry failed. Will try again later.', false);
        return;
      }
    }

    localStorage.removeItem('contact_pending');
    setStatus('All pending requests sent.', true);
  });
})();
</script>

{% endblock %}

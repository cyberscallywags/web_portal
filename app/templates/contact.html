{% extends "base.html" %}
{% block title %}Contact - Cyber Scallywags{% endblock %}
{% block content %}
<h1 style="color: #CC0084;">Contact Cyber Scallywags  üê∫</h1>
<p style="color: #00B1B3;">Cyber Scallywags is a lightweight, community-driven application that helps developers adopt clean coding practices effortlessly.</p>

<!-- Contact form -->
<section class="mt-4">
  <h2 style="color: #C1E415;">Get in touch</h2>
  <form id="joinForm" data-api-url="/api/contact" class="row g-3" novalidate>
    
    <!-- Form Type Selector -->
    <div class="col-12" style="color: #00B1B3;">
      <label for="formType" class="form-label">What would you like to do?</label>
      <select class="form-select" id="formType" name="formType" required>
        <!-- <option value="">Please select...</option> -->
        <option value="mailing-list">Join mailing list</option>
        <option value="apply-to-join">Apply to join</option>
        <option value="general-enquiry">General enquiry</option>
      </select>
      <div class="invalid-feedback">Please select an option.</div>
    </div>

    <!-- Name field - always visible -->
    <div class="col-md-6" style="color: #00B1B3;">
      <label for="name" class="form-label">Full name</label>
      <input type="text" class="form-control" id="name" name="name" required maxlength="120" placeholder="Your name">
      <div class="invalid-feedback">Please provide your name.</div>
    </div>

    <!-- Email field - always visible -->
    <div class="col-md-6" style="color: #00B1B3;">
      <label for="email" class="form-label">Email address</label>
      <input type="email" class="form-control" id="email" name="email" required maxlength="254" placeholder="you@example.com">
      <div class="invalid-feedback">Please provide a valid email.</div>
    </div>

    <!-- Role field - only for apply-to-join -->
    <div class="col-12 field-role" style="color: #00B1B3; display: none;">
      <label for="role" class="form-label">Interest / Role</label>
      <input type="text" class="form-control" id="role" name="role" placeholder="e.g. volunteer, mentor, learner">
    </div>

    <!-- Message field - for apply-to-join and general-enquiry -->
    <div class="col-12 field-message" style="color: #00B1B3; display: none;">
      <label for="message" class="form-label"><span class="message-label">Optional message</span></label>
      <textarea id="message" name="message" class="form-control" rows="3" maxlength="1000" placeholder="Tell us a bit about yourself (optional)"></textarea>
    </div>

    <!-- Consent checkbox - always visible -->
    <div class="col-12 form-check" style="color: #00B1B3;">
      <input class="form-check-input" type="checkbox" value="yes" id="consent" required>
      <label class="form-check-label" for="consent">
        I consent to my details being stored and used to contact me.
      </label>
      <div class="invalid-feedback">Consent is required.</div>
    </div>

    <div class="col-12">
      <button id="submitBtn" class="btn btn-primary">Send request</button>
      <span id="formStatus" class="ms-3" aria-live="polite"></span>
    </div>
  </form>
</section>

<script>
(function () {
  const form = document.getElementById('joinForm');
  const statusEl = document.getElementById('formStatus');
  const formTypeSelect = document.getElementById('formType');
  const roleField = document.querySelector('.field-role');
  const messageField = document.querySelector('.field-message');
  const messageLabel = document.querySelector('.message-label');
  const roleInput = document.getElementById('role');
  const messageInput = document.getElementById('message');
  const apiUrl = form.dataset.apiUrl || '/api/contact';

  // Handle form type changes
  formTypeSelect.addEventListener('change', function() {
    const formType = this.value;
    
    // Reset visibility and requirements
    roleField.style.display = 'none';
    messageField.style.display = 'none';
    roleInput.required = false;
    messageInput.required = false;
    
    // Show/hide fields based on selection
    switch(formType) {
      case 'mailing-list':
        // Only name and email needed
        break;
        
      case 'apply-to-join':
        // Show role and message fields
        roleField.style.display = 'block';
        messageField.style.display = 'block';
        roleInput.required = true;
        messageLabel.textContent = 'Tell us about yourself';
        messageInput.placeholder = 'Tell us about your experience and why you want to join';
        messageInput.required = true;
        break;
        
      case 'general-enquiry':
        // Show message field only (no role)
        messageField.style.display = 'block';
        messageLabel.textContent = 'Your message';
        messageInput.placeholder = 'Please tell us how we can help you';
        messageInput.required = true;
        break;
    }
  });

  function setStatus(msg, ok = true) {
    statusEl.textContent = msg;
    statusEl.style.color = ok ? '#C1E415' : '#ff6b6b';
  }

  // Bootstrap-style client validation
  form.addEventListener('submit', async function (e) {
    e.preventDefault();
    e.stopPropagation();

    if (!form.checkValidity()) {
      form.classList.add('was-validated');
      setStatus('Please correct the highlighted fields.', false);
      return;
    }

    const payload = {
      formType: formTypeSelect.value,
      name: form.name.value.trim(),
      email: form.email.value.trim().toLowerCase(),
      role: form.role.value.trim(),
      message: form.message.value.trim(),
      consent: !!document.getElementById('consent').checked,
      submitted_at: new Date().toISOString()
    };

    // store locally as JSON fallback
    try {
      const existing = JSON.parse(localStorage.getItem('contact_pending') || '[]');
      existing.push(payload);
      localStorage.setItem('contact_pending', JSON.stringify(existing));
    } catch (err) {
      // ignore localStorage errors
    }

    setStatus('Sending...', true);
    document.getElementById('submitBtn').disabled = true;

    try {
      const res = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify(payload),
        credentials: 'same-origin'
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || 'Server returned an error');
      }

      // successful post
      setStatus('Request sent. Thank you ‚Äî we will be in touch soon.', true);
      form.reset();
      form.classList.remove('was-validated');
      
      // Reset form visibility
      roleField.style.display = 'none';
      messageField.style.display = 'none';
      roleInput.required = false;
      messageInput.required = false;

      // optionally remove the stored item(s) or mark them as sent
      localStorage.removeItem('contact_pending');
    } catch (err) {
      console.error('Contact form error:', err);
      setStatus('Failed to send ‚Äî your request is saved locally and will be retried later.', false);
      // leave payload in localStorage for retry
    } finally {
      document.getElementById('submitBtn').disabled = false;
    }
  });

  // optional: try to resend pending entries when online
  window.addEventListener('online', async function () {
    const pending = JSON.parse(localStorage.getItem('contact_pending') || '[]');
    if (!pending.length) return;
    setStatus('Retrying pending requests...', true);

    for (const p of pending.slice()) {
      try {
        const res = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify(p),
          credentials: 'same-origin'
        });
        if (!res.ok) throw new Error('Server error');
      } catch (err) {
        console.warn('Retry failed', err);
        setStatus('Retry failed. Will try again later.', false);
        return;
      }
    }

    localStorage.removeItem('contact_pending');
    setStatus('All pending requests sent.', true);
  });
})();
</script>

{% endblock %}
